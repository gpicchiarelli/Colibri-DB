name: TLA+ Specification Verification

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'spec/**'
      - 'Sources/ColibriCore/**'
      - '.github/workflows/spec.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'spec/**'
      - 'Sources/ColibriCore/**'

jobs:
  verify-specs:
    name: Verify TLA+ Specifications
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Download TLA+ Tools
        run: |
          wget -q https://github.com/tlaplus/tlaplus/releases/latest/download/tla2tools.jar
          echo "Downloaded TLA+ tools"
      
      - name: Verify Core Modules
        run: |
          echo "âœ… Skipping CORE.tla (no executable spec)"
          echo "âœ… Skipping INTERFACES.tla (interface definitions only)"
          echo "âœ… Skipping DISK_FORMAT.tla (format definitions only)"
      
      - name: Verify WAL Specification
        run: |
          echo "ğŸ” Checking WAL.tla..."
          java -cp tla2tools.jar tlc2.TLC \
            -workers 4 \
            -coverage 1 \
            -deadlock \
            -config spec/WAL.cfg \
            spec/WAL.tla || exit 1
          echo "âœ… WAL specification verified"
      
      - name: Verify MVCC Specification
        run: |
          echo "ğŸ” Checking MVCC.tla..."
          java -cp tla2tools.jar tlc2.TLC \
            -workers 4 \
            -coverage 1 \
            -deadlock \
            -config spec/MVCC.cfg \
            spec/MVCC.tla || exit 1
          echo "âœ… MVCC specification verified"
      
      - name: Verify LockManager Specification
        run: |
          echo "ğŸ” Checking LockManager.tla..."
          java -cp tla2tools.jar tlc2.TLC \
            -workers 4 \
            -coverage 1 \
            -deadlock \
            -config spec/LockManager.cfg \
            spec/LockManager.tla || exit 1
          echo "âœ… LockManager specification verified"
      
      - name: Verify BTree Specification
        run: |
          echo "ğŸ” Checking BTree.tla..."
          java -cp tla2tools.jar tlc2.TLC \
            -workers 4 \
            -coverage 1 \
            -deadlock \
            -config spec/BTree.cfg \
            spec/BTree.tla || exit 1
          echo "âœ… BTree specification verified"
      
      - name: Verify BufferPool Specification
        run: |
          echo "ğŸ” Checking BufferPool.tla..."
          java -cp tla2tools.jar tlc2.TLC \
            -workers 4 \
            -coverage 1 \
            -deadlock \
            -config spec/BufferPool.cfg \
            spec/BufferPool.tla || exit 1
          echo "âœ… BufferPool specification verified"
      
      - name: Verify RECOVERY Specification
        run: |
          echo "ğŸ” Checking RECOVERY.tla..."
          java -cp tla2tools.jar tlc2.TLC \
            -workers 4 \
            -coverage 1 \
            -deadlock \
            -config spec/RECOVERY.cfg \
            spec/RECOVERY.tla || exit 1
          echo "âœ… RECOVERY specification verified"
      
      - name: Verify TransactionManager Specification
        run: |
          echo "ğŸ” Checking TransactionManager.tla..."
          java -cp tla2tools.jar tlc2.TLC \
            -workers 4 \
            -coverage 1 \
            -deadlock \
            -config spec/TransactionManager.cfg \
            spec/TransactionManager.tla || exit 1
          echo "âœ… TransactionManager specification verified"
      
      - name: Verify HeapTable Specification
        run: |
          echo "ğŸ” Checking HeapTable.tla..."
          java -cp tla2tools.jar tlc2.TLC \
            -workers 4 \
            -coverage 1 \
            -deadlock \
            -config spec/HeapTable.cfg \
            spec/HeapTable.tla || exit 1
          echo "âœ… HeapTable specification verified"
      
      - name: Verify GroupCommit Specification
        run: |
          echo "ğŸ” Checking GroupCommit.tla..."
          java -cp tla2tools.jar tlc2.TLC \
            -workers 4 \
            -coverage 1 \
            -deadlock \
            -config spec/GroupCommit.cfg \
            spec/GroupCommit.tla || exit 1
          echo "âœ… GroupCommit specification verified"
      
      - name: Verify Catalog Specification
        run: |
          echo "ğŸ” Checking Catalog.tla..."
          java -cp tla2tools.jar tlc2.TLC \
            -workers 4 \
            -coverage 1 \
            -deadlock \
            -config spec/Catalog.cfg \
            spec/Catalog.tla || exit 1
          echo "âœ… Catalog specification verified"
      
      - name: Summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… ALL TLA+ SPECIFICATIONS VERIFIED SUCCESSFULLY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Verified modules:"
          echo "  âœ… WAL (6 invariants)"
          echo "  âœ… MVCC (3 invariants)"
          echo "  âœ… LockManager (2 invariants)"
          echo "  âœ… BTree (3 invariants)"
          echo "  âœ… BufferPool (3 invariants)"
          echo "  âœ… RECOVERY (2 invariants)"
          echo "  âœ… TransactionManager (3 invariants)"
          echo "  âœ… HeapTable (3 invariants)"
          echo "  âœ… GroupCommit (3 invariants)"
          echo "  âœ… Catalog (3 invariants)"
          echo ""
          echo "Total: 31 invariants verified"
          echo ""
          echo "All critical safety properties hold âœ“"
      
      - name: Upload TLC Reports
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: tlc-reports
          path: |
            *.out
            states/
          retention-days: 7
