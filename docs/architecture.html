<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ColibrìDB - Architecture</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <style>
        .architecture-diagram {
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
        }
        .layer {
            background: #fff;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .layer h3 {
            margin-top: 0;
            color: #0366d6;
            border-bottom: 2px solid #0366d6;
            padding-bottom: 10px;
        }
        .component {
            background: #f8f9fa;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 10px 0;
        }
        .component h4 {
            margin-top: 0;
            color: #28a745;
        }
        .tla-badge {
            display: inline-block;
            background: #17a2b8;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            margin-left: 5px;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .metric-card {
            background: #fff;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #0366d6;
        }
        .metric-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <span class="brand-icon">🐦</span>
                <span class="brand-text">ColibrìDB</span>
            </div>
            <div class="nav-menu">
                <a href="index.html" class="nav-link">Home</a>
                <a href="architecture.html" class="nav-link active">Architettura</a>
                <a href="documentation.html" class="nav-link">Documentazione</a>
                <a href="tla-specifications.html" class="nav-link">TLA+ Specs</a>
                <a href="performance.html" class="nav-link">Performance</a>
                <a href="https://github.com/gpicchiarelli/Colibri-DB" class="nav-link external" target="_blank">GitHub</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <div class="page-header">
                <h1>Architettura ColibrìDB</h1>
                <p class="page-description">
                    Architettura completa di un database relazionale formalmente verificato
                </p>
            </div>

        <section class="overview">
            <h2>Panoramica Architetturale</h2>
            <p>ColibrìDB è un database relazionale completo implementato in Swift 6.2 con verifica formale TLA+. L'architettura è progettata per garantire correttezza, performance e scalabilità attraverso l'uso di specifiche formali e implementazione rigorosa.</p>
            
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value">69</div>
                    <div class="metric-label">Specifiche TLA+</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">76</div>
                    <div class="metric-label">Moduli Swift</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">15,000+</div>
                    <div class="metric-label">Linee di Codice</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">250+</div>
                    <div class="metric-label">Invarianti</div>
                </div>
            </div>
        </section>

        <section class="architecture-diagram">
            <h2>Architettura del Sistema</h2>
            <div class="architecture-diagram">
                <h3>ColibrìDB - Architettura Completa</h3>
                <div style="font-family: monospace; text-align: left; background: #f8f9fa; padding: 20px; border-radius: 4px; margin: 20px 0;">
┌─────────────────────────────────────────────────────────────────┐
│                    CLIENT LAYER                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │   CLI Tool  │  │  Web UI     │  │  API Client │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    PROTOCOL LAYER                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │ Wire Protocol│  │  TLS/SSL    │  │  Auth Layer │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    SERVER LAYER                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │Connection Mgr│  │  Query Mgr  │  │  Session Mgr│            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    QUERY LAYER                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │ SQL Parser  │  │  Optimizer  │  │  Executor   │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                  TRANSACTION LAYER                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │Transaction  │  │  Lock Mgr   │  │    MVCC     │            │
│  │   Manager   │  │             │  │             │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    STORAGE LAYER                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │ Buffer Pool │  │     WAL     │  │ Heap Tables │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │   Indexes   │  │  Recovery   │  │   Backup    │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    DISTRIBUTED LAYER                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │    Raft     │  │     2PC     │  │ Replication │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
└─────────────────────────────────────────────────────────────────┘
                </div>
            </div>
        </section>

        <section class="layers">
            <h2>Livelli Architetturali</h2>

            <div class="layer">
                <h3>🌐 Client Layer</h3>
                <p>Interfacce per l'accesso al database</p>
                <div class="component">
                    <h4>CLI Tool (coldb) <span class="tla-badge">CLI.tla</span></h4>
                    <p>Strumento amministrativo per gestione database, backup, monitoring e troubleshooting.</p>
                </div>
                <div class="component">
                    <h4>Web UI <span class="tla-badge">WebUI.tla</span></h4>
                    <p>Interfaccia web per amministrazione e monitoring in tempo reale.</p>
                </div>
                <div class="component">
                    <h4>API Client <span class="tla-badge">APIClient.tla</span></h4>
                    <p>Client programmatico per integrazione con applicazioni Swift.</p>
                </div>
            </div>

            <div class="layer">
                <h3>🔌 Protocol Layer</h3>
                <p>Protocolli di comunicazione e sicurezza</p>
                <div class="component">
                    <h4>Wire Protocol <span class="tla-badge">WireProtocol.tla</span></h4>
                    <p>Protocollo binario efficiente per comunicazione client-server con serializzazione custom.</p>
                </div>
                <div class="component">
                    <h4>TLS/SSL <span class="tla-badge">TLS.tla</span></h4>
                    <p>Crittografia end-to-end per sicurezza delle comunicazioni.</p>
                </div>
                <div class="component">
                    <h4>Authentication Layer <span class="tla-badge">Authentication.tla</span></h4>
                    <p>Autenticazione sicura con SCRAM e Argon2 password hashing.</p>
                </div>
            </div>

            <div class="layer">
                <h3>🖥️ Server Layer</h3>
                <p>Gestione connessioni e sessioni</p>
                <div class="component">
                    <h4>Connection Manager <span class="tla-badge">ConnectionManager.tla</span></h4>
                    <p>Gestione pool di connessioni con thread pool e load balancing.</p>
                </div>
                <div class="component">
                    <h4>Query Manager <span class="tla-badge">QueryManager.tla</span></h4>
                    <p>Orchestrazione del processing delle query end-to-end.</p>
                </div>
                <div class="component">
                    <h4>Session Manager <span class="tla-badge">SessionManager.tla</span></h4>
                    <p>Gestione sessioni utente con isolamento e timeout.</p>
                </div>
            </div>

            <div class="layer">
                <h3>🔍 Query Layer</h3>
                <p>Elaborazione e ottimizzazione query</p>
                <div class="component">
                    <h4>SQL Parser <span class="tla-badge">SQLParser.tla</span></h4>
                    <p>Parser SQL completo con type checking e validazione sintattica.</p>
                </div>
                <div class="component">
                    <h4>Query Optimizer <span class="tla-badge">QueryOptimizer.tla</span></h4>
                    <p>Ottimizzazione cost-based con Selinger algorithm e statistiche.</p>
                </div>
                <div class="component">
                    <h4>Query Executor <span class="tla-badge">QueryExecutor.tla</span></h4>
                    <p>Esecuzione operatori relazionali con pipeline e materializzazione.</p>
                </div>
            </div>

            <div class="layer">
                <h3>⚡ Transaction Layer</h3>
                <p>Gestione transazioni e concorrenza</p>
                <div class="component">
                    <h4>Transaction Manager <span class="tla-badge">TransactionManager.tla</span></h4>
                    <p>Gestione transazioni ACID con Two-Phase Commit e deadlock detection.</p>
                </div>
                <div class="component">
                    <h4>Lock Manager <span class="tla-badge">LockManager.tla</span></h4>
                    <p>Gestione lock con 5 modalità e rilevamento deadlock DFS.</p>
                </div>
                <div class="component">
                    <h4>MVCC <span class="tla-badge">MVCC.tla</span></h4>
                    <p>Multi-Version Concurrency Control con snapshot isolation e SSI.</p>
                </div>
            </div>

            <div class="layer">
                <h3>🗄️ Storage Layer</h3>
                <p>Gestione persistenza e indicizzazione</p>
                <div class="component">
                    <h4>Buffer Pool <span class="tla-badge">BufferPool.tla</span></h4>
                    <p>Cache intelligente con LRU/Clock-Sweep eviction e dirty page tracking.</p>
                </div>
                <div class="component">
                    <h4>Write-Ahead Log <span class="tla-badge">WAL.tla</span></h4>
                    <p>Logging per durabilità con group commit e checksum CRC32.</p>
                </div>
                <div class="component">
                    <h4>Heap Tables <span class="tla-badge">HeapTable.tla</span></h4>
                    <p>Storage engine con slotted pages e free space management.</p>
                </div>
                <div class="component">
                    <h4>Index Manager <span class="tla-badge">IndexManager.tla</span></h4>
                    <p>Gestione 9 tipi di indici: B+Tree, Hash, ART, LSM, Fractal, Skip, T-Tree, Radix, Bloom.</p>
                </div>
                <div class="component">
                    <h4>Recovery Manager <span class="tla-badge">RECOVERY.tla</span></h4>
                    <p>Recupero crash con algoritmo ARIES (Analysis, Redo, Undo).</p>
                </div>
                <div class="component">
                    <h4>Backup Manager <span class="tla-badge">Backup.tla</span></h4>
                    <p>Backup completo e incrementale con point-in-time recovery.</p>
                </div>
            </div>

            <div class="layer">
                <h3>🌐 Distributed Layer</h3>
                <p>Sistemi distribuiti e consenso</p>
                <div class="component">
                    <h4>Raft Consensus <span class="tla-badge">ConsensusProtocol.tla</span></h4>
                    <p>Protocollo di consenso per elezione leader e replicazione log.</p>
                </div>
                <div class="component">
                    <h4>Two-Phase Commit <span class="tla-badge">TwoPhaseCommit.tla</span></h4>
                    <p>Transazioni distribuite ACID con timeout e recovery.</p>
                </div>
                <div class="component">
                    <h4>Replication Manager <span class="tla-badge">Replication.tla</span></h4>
                    <p>Replicazione master-slave e multi-master con conflict resolution.</p>
                </div>
            </div>
        </section>

        <section class="design-principles">
            <h2>Principi di Design</h2>
            
            <h3>🔬 Verifica Formale</h3>
            <p>Ogni componente critico ha una specifica TLA+ completa con:</p>
            <ul>
                <li><strong>Invarianti</strong>: Proprietà che devono sempre essere soddisfatte</li>
                <li><strong>Liveness Properties</strong>: Proprietà temporali che devono eventualmente essere soddisfatte</li>
                <li><strong>Model Checking</strong>: Verifica automatica con TLC</li>
                <li><strong>Runtime Verification</strong>: Controllo invarianti in tempo reale</li>
            </ul>

            <h3>⚡ Concorrenza Sicura</h3>
            <p>Architettura basata su Swift actors per:</p>
            <ul>
                <li><strong>Isolamento</strong>: Un task per volta per actor</li>
                <li><strong>Safety</strong>: Zero data races garantiti</li>
                <li><strong>Async/Await</strong>: Concorrenza non-bloccante</li>
                <li><strong>Type Safety</strong>: Controlli statici completi</li>
            </ul>

            <h3>🎯 Performance</h3>
            <p>Ottimizzazioni per database ad alte prestazioni:</p>
            <ul>
                <li><strong>Group Commit</strong>: Batch I/O per throughput elevato</li>
                <li><strong>Clock-Sweep Eviction</strong>: O(1) amortized eviction</li>
                <li><strong>Index Optimization</strong>: 9 tipi di indici per accesso ottimizzato</li>
                <li><strong>Query Optimization</strong>: Cost-based planning con statistiche</li>
            </ul>

            <h3>🔒 Sicurezza</h3>
            <p>Modelli di sicurezza multipli per defense in depth:</p>
            <ul>
                <li><strong>Authentication</strong>: SCRAM + Argon2</li>
                <li><strong>Authorization</strong>: RBAC, ACL, MAC, ABAC, Capabilities</li>
                <li><strong>Encryption</strong>: TLS end-to-end</li>
                <li><strong>Audit</strong>: Logging completo per compliance</li>
            </ul>
        </section>

        <section class="data-flow">
            <h2>Flusso Dati</h2>
            
            <h3>Query Processing</h3>
            <ol>
                <li><strong>Parsing</strong>: SQL → AST con type checking</li>
                <li><strong>Planning</strong>: AST → Logical plan → Physical plan</li>
                <li><strong>Optimization</strong>: Cost-based optimization con statistiche</li>
                <li><strong>Execution</strong>: Esecuzione operatori relazionali</li>
                <li><strong>Result</strong>: Serializzazione e invio risultati</li>
            </ol>

            <h3>Transaction Processing</h3>
            <ol>
                <li><strong>Begin</strong>: Allocazione TxID e snapshot</li>
                <li><strong>Operations</strong>: Read/Write con MVCC e locking</li>
                <li><strong>WAL</strong>: Logging per durabilità</li>
                <li><strong>Commit</strong>: 2PC per transazioni distribuite</li>
                <li><strong>Recovery</strong>: ARIES per crash recovery</li>
            </ol>

            <h3>Storage Operations</h3>
            <ol>
                <li><strong>Buffer Pool</strong>: Cache hit/miss con eviction</li>
                <li><strong>WAL</strong>: Log-before-data enforcement</li>
                <li><strong>Heap Storage</strong>: Slotted pages con free space</li>
                <li><strong>Indexes</strong>: B+Tree, Hash, ART per accesso veloce</li>
                <li><strong>Recovery</strong>: ARIES analysis, redo, undo</li>
            </ol>
        </section>

        <section class="scalability">
            <h2>Scalabilità e Distribuzione</h2>
            
            <h3>Scaling Verticale</h3>
            <ul>
                <li><strong>Buffer Pool</strong>: Cache memory configurabile</li>
                <li><strong>Thread Pool</strong>: Connessioni concorrenti</li>
                <li><strong>Index Types</strong>: Selezione ottimale per workload</li>
                <li><strong>Query Optimization</strong>: Planning adattivo</li>
            </ul>

            <h3>Scaling Orizzontale</h3>
            <ul>
                <li><strong>Sharding</strong>: Partizionamento hash e range-based</li>
                <li><strong>Replication</strong>: Master-slave e multi-master</li>
                <li><strong>Consensus</strong>: Raft per coerenza forte</li>
                <li><strong>Load Balancing</strong>: Distribuzione automatica carico</li>
            </ul>

            <h3>Fault Tolerance</h3>
            <ul>
                <li><strong>Crash Recovery</strong>: ARIES per consistenza</li>
                <li><strong>Network Partitions</strong>: Raft per split-brain prevention</li>
                <li><strong>Chaos Engineering</strong>: Testing resilienza integrato</li>
                <li><strong>Backup/Restore</strong>: Point-in-time recovery</li>
            </ul>
        </section>

        <section class="monitoring">
            <h2>Monitoring e Observability</h2>
            
            <h3>Metriche Performance</h3>
            <ul>
                <li><strong>Throughput</strong>: TPS, QPS, WAL ops/sec</li>
                <li><strong>Latency</strong>: Query time, commit time, lock wait</li>
                <li><strong>Resource Usage</strong>: CPU, memory, disk I/O</li>
                <li><strong>Cache Efficiency</strong>: Hit rate, eviction rate</li>
            </ul>

            <h3>Health Checks</h3>
            <ul>
                <li><strong>System Health</strong>: Buffer pool, WAL, indexes</li>
                <li><strong>Transaction Health</strong>: Deadlock rate, abort rate</li>
                <li><strong>Storage Health</strong>: Disk space, fragmentation</li>
                <li><strong>Network Health</strong>: Connection count, replication lag</li>
            </ul>

            <h3>Alerting</h3>
            <ul>
                <li><strong>Performance Alerts</strong>: Latency spikes, throughput drops</li>
                <li><strong>Error Alerts</strong>: Deadlocks, failures, corruption</li>
                <li><strong>Resource Alerts</strong>: Memory pressure, disk full</li>
                <li><strong>Security Alerts</strong>: Failed logins, privilege escalation</li>
            </ul>
        </section>

        <section class="testing">
            <h2>Testing e Qualità</h2>
            
            <h3>Verifica Formale</h3>
            <ul>
                <li><strong>TLA+ Model Checking</strong>: Verifica invarianti per tutti gli stati</li>
                <li><strong>Runtime Assertions</strong>: Controllo invarianti in tempo reale</li>
                <li><strong>Property Testing</strong>: 154 test basati su proprietà TLA+</li>
                <li><strong>Integration Testing</strong>: Test end-to-end con scenari reali</li>
            </ul>

            <h3>Chaos Engineering</h3>
            <ul>
                <li><strong>Fault Injection</strong>: Network, disk, memory failures</li>
                <li><strong>Chaos Experiments</strong>: 8 tipi di esperimenti</li>
                <li><strong>Recovery Testing</strong>: Verifica resilienza e recovery</li>
                <li><strong>Load Testing</strong>: Stress test con carico elevato</li>
            </ul>

            <h3>Quality Gates</h3>
            <ul>
                <li><strong>Code Coverage</strong>: 100% per moduli critici</li>
                <li><strong>Performance Regression</strong>: < 5% degradation</li>
                <li><strong>Security Scanning</strong>: CodeQL e SAST</li>
                <li><strong>Documentation</strong>: Sincronizzazione con codice</li>
            </ul>
        </section>

        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>ColibrìDB</h3>
                    <p>RDBMS moderno e performante per macOS, con architettura modulare e verifiche formali complete.</p>
                </div>
                <div class="footer-section">
                    <h3>Risorse</h3>
                    <ul>
                        <li><a href="documentation.html">Documentazione</a></li>
                        <li><a href="architecture.html">Architettura</a></li>
                        <li><a href="tla-specifications.html">Specifiche TLA+</a></li>
                        <li><a href="api-reference.html">API Reference</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Community</h3>
                    <ul>
                        <li><a href="https://github.com/gpicchiarelli/Colibri-DB" target="_blank">GitHub</a></li>
                        <li><a href="https://github.com/gpicchiarelli/Colibri-DB/issues" target="_blank">Segnala Bug</a></li>
                        <li><a href="https://github.com/gpicchiarelli/Colibri-DB/discussions" target="_blank">Discussioni</a></li>
                        <li><a href="https://github.com/gpicchiarelli/Colibri-DB/blob/main/CONTRIBUTING.md" target="_blank">Contribuisci</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 ColibrìDB · Swift 6.2 · Licenza BSD-3-Clause</p>
            </div>
        </div>
    </footer>
</body>
</html>